<?php

/**
 * @file
 */

declare(strict_types=1);

/**
 * @file
 * Paragraph Bundle Parallax.
 *
 * Filename:     paragraph_bundle_parallax.module
 * Website:      https://www.flashwebcenter.com
 * Description:  template.
 * Developer:    Alaa Haddad https://www.alaahaddad.com.
 */

use Drupal\Component\Serialization\Yaml;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Config\FileStorage;

/**
 * Implements hook_help().
 */
function paragraph_bundle_parallax_help($route_name, RouteMatchInterface $route_match) {
  if ($route_name === 'help.page.paragraph_bundle_parallax') {
    return paragraphs_bundles__helper_render_readme();
  }
  return NULL;
}

/**
 * Implements hook_theme().
 */
function paragraph_bundle_parallax_theme($existing, $type, $theme, $path) {
  return [
    'paragraph__parallax_bundle' => [
      'base hook' => 'paragraph',
    ],
    'paragraph__parallax_section_bundle' => [
      'base hook' => 'paragraph',
    ],
  ];
}

/**
 * Create the fields from the yml file.
 *
 * @param string $moduleName
 *   Module name.
 * @param array $newFields
 *   An array of config names to create.
 */
function _paragraph_bundle_parallax_update_fields_from_yml($moduleName, array $newFields) {
  $module_handler = \Drupal::moduleHandler();
  $config_storage = new FileStorage(
    $module_handler->getModule($moduleName)->getPath() . '/config/optional'
  );

  foreach ($newFields as $config_name) {
    // Check if config already exists.
    $existing = \Drupal::configFactory()->get($config_name);
    if (!$existing->isNew()) {
      \Drupal::logger('paragraph_bundle_parallax')->notice('Config @name already exists, skipping', ['@name' => $config_name]);
      continue;
    }

    $config_record = $config_storage->read($config_name);
    if (!$config_record) {
      \Drupal::logger('paragraph_bundle_parallax')->warning('Config file @name not found', ['@name' => $config_name]);
      continue;
    }

    $entity_type = \Drupal::service('config.manager')->getEntityTypeIdByName($config_name);
    /** @var \Drupal\Core\Config\Entity\ConfigEntityStorageInterface $storage */
    $storage = \Drupal::entityTypeManager()->getStorage($entity_type);
    $entity = $storage->createFromStorageRecord($config_record);
    $entity->save();

    \Drupal::logger('paragraph_bundle_parallax')->notice('Created config @name', ['@name' => $config_name]);
  }
}

/**
 * Add new parallax fields and update displays.
 */
function paragraph_bundle_parallax_update_8103() {
  $messages = [];
  $module_path = \Drupal::service('extension.list.module')->getPath('paragraph_bundle_parallax');

  // All new field configurations to create.
  $field_configs = [
    // Field storages.
    'field.storage.paragraph.pb_display_para_anim_easing',
    'field.storage.paragraph.pb_display_para_bg_anim_speed',
    'field.storage.paragraph.pb_display_parallax_bg_position',
    'field.storage.paragraph.pb_display_para_height_unit',
    'field.storage.paragraph.pb_display_parallax_breakpoints',
    'field.storage.paragraph.pb_display_parallax_scroll',
    'field.storage.paragraph.pb_display_parallax_speed',

    // Field instances.
    'field.field.paragraph.parallax_section_bundle.pb_display_para_anim_easing',
    'field.field.paragraph.parallax_section_bundle.pb_display_para_bg_anim_speed',
    'field.field.paragraph.parallax_section_bundle.pb_display_parallax_bg_position',
    'field.field.paragraph.parallax_section_bundle.pb_display_para_height_unit',
    'field.field.paragraph.parallax_section_bundle.pb_display_parallax_breakpoints',
    'field.field.paragraph.parallax_section_bundle.pb_display_parallax_scroll',
    'field.field.paragraph.parallax_section_bundle.pb_display_parallax_speed',
  ];

  // List of new field names.
  $new_field_names = [
    'pb_display_para_anim_easing',
    'pb_display_para_bg_anim_speed',
    'pb_display_parallax_bg_position',
    'pb_display_para_height_unit',
    'pb_display_parallax_breakpoints',
    'pb_display_parallax_scroll',
    'pb_display_parallax_speed',
  ];

  // Create the fields.
  _paragraph_bundle_parallax_update_fields_from_yml('paragraph_bundle_parallax', $field_configs);
  $messages[] = 'Created field storages and field instances';

  // Update form display - completely rebuild from YAML.
  $form_display = \Drupal::entityTypeManager()->getStorage('entity_form_display')->load('paragraph.parallax_section_bundle.default');
  if ($form_display) {
    $new_form_config = Yaml::decode(
      file_get_contents($module_path . '/config/optional/core.entity_form_display.paragraph.parallax_section_bundle.default.yml')
    );

    if ($new_form_config) {
      // Completely replace with YAML configuration to ensure exact field ordering.
      $form_display->set('content', $new_form_config['content']);
      $form_display->set('hidden', $new_form_config['hidden']);
      $form_display->set('third_party_settings', $new_form_config['third_party_settings']);
      $form_display->save();

      $messages[] = 'Rebuilt form display from YAML configuration';
    }
  }
  else {
    $messages[] = 'Warning: Form display not found';
  }

  // Update view display - completely rebuild from YAML.
  $view_display = \Drupal::entityTypeManager()->getStorage('entity_view_display')->load('paragraph.parallax_section_bundle.default');
  if ($view_display) {
    $new_view_config = Yaml::decode(
      file_get_contents($module_path . '/config/optional/core.entity_view_display.paragraph.parallax_section_bundle.default.yml')
    );

    if ($new_view_config) {
      // Completely replace with YAML configuration to ensure exact field ordering.
      $view_display->set('content', $new_view_config['content']);
      $view_display->set('hidden', $new_view_config['hidden']);
      $view_display->save();

      $messages[] = 'Rebuilt view display from YAML configuration';
    }
  }
  else {
    $messages[] = 'Warning: View display not found';
  }

  // Clear caches.
  \Drupal::service('plugin.manager.field.widget')->clearCachedDefinitions();
  \Drupal::service('plugin.manager.field.formatter')->clearCachedDefinitions();
  \Drupal::service('entity_field.manager')->clearCachedFieldDefinitions();
  $messages[] = 'Cleared field caches';

  // Log success.
  foreach ($messages as $message) {
    \Drupal::logger('paragraph_bundle_parallax')->notice($message);
  }

  \Drupal::messenger()->addMessage('New parallax fields have been added with legacy mode support.');

  return implode(' ', $messages);
}
